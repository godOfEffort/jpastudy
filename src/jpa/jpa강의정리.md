## 영속성 관리

---

### 엔티티 매니저 팩토리와 엔티티 매니저
엔티티 매니저 팩토리는 한 개만 만들어서 애플리케이션 전체에서 공유한다.
엔티티 매니저 팩토리는 여러 스레드가 동시에 접근해도 안전하므로 서로 다른
스레드 간에 공유해도 되지만, 엔티티 매니저는 여러 스레드가 동시에 접근하면 동시성
문제가 발생하므로 스레드 간에 절대 공유하면 안된다.

### 영속성 컨텍스트란?
엔티티를 영구저장하는 환경이란 의미이다. 영속성 컨텍스트는 엔티티 매니저를 생성할 때 하나 만들어진다.

### 엔티티의 생명주기
비영속 : 영속성 컨텍스트와 전혀 관계가 없는 상태
영속 : 영속성 컨테스트에 저장된 상태
준영속 : 영속성 컨텍스트에 저장되었다가 분리된 상태
삭제 : 삭제된 상태

- 비영속
```java
Member member = new Member();
member.setId("member1");
member.setUsername("회원1");
```

엔티티 객체를 생성했지만 순수한 자바 객체 상태이며 아직 저장하지 않았으므로 영속성 컨텍스트나
데이터베이스와는 전혀 관련이 없다. 이것을 비영속 상태라고 한다

- 영속
```java
//객체를 저장한 상태(영속)
em.persist(member);
```

엔티티 매니저를 통해서 엔티티를 영속성 컨텍스트에 저장하여 영속성 컨텍스트가
관리하는 엔티티를 영속 상태라고 한다. 결국 영속 상태라는 것은 영속성 컨텍스트에 의해
관리된다는 뜻이다.

- 준영속
영속성 컨텍스트가 관리하던 영속 상태의 엔티티를 영속성 컨텍스트가 관리하지 않으면 준영속 상태가 된다.

- 삭제
엔티티를 영속성 컨텍스트와 데이터베이스에서 삭제한다.


### 영속성 컨텍스트의 특징

1) 영속성 컨텍스트와 식별자 값
영속성 컨텍스트는 엔티티를 식별자 값(@Id로 매핑한 값)으로 구분한다. 따라서 영속상태는 식별자 값이 반드시 있어야 한다.
식별자 값이 없으면 예외가 발생한다.

2) 영속성 컨텍스트와 데이터베이스 저장
JPA는 보통 트랜잭션을 커밋하는 순간 영속성 컨텍스트에 새로 저장된 엔티티를 데이터베이스에 반영한다. 
이것을 `플러시`라 한다.

### 엔티티 조회
영속성 컨텍스트는 내부에 캐시를 가지고 있는데 이것을 1차 캐시라고 한다.
em.find()를 호출하면 우선 1차 캐시에서 식별자 값으로 엔티티를 찾는다. 찾는 엔티티가 있으면
데이터베이스를 조회하지 않고 메모리에 있는 1차 캐시에서 엔티티를 조회한다.

### 데이터베이스에서 조회
em.find()를 호출했는데 1차 캐시에 없으면 엔티티 매니저는 데이터베이스를 조회해서 엔티티를 생성한 뒤
1차 캐시에 저장한 후에 영속 상태의 엔티티를 반환한다.

### 영속 엔티티의 동일성 보장